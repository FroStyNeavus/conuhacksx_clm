<!doctype html>
<html>
  <head>
    <title>Commodities Map with Deck.GL</title>
    <link rel="stylesheet" type="text/css" href="./style.css" />
    <!-- Deck.gl bundle (includes all modules) -->
    <script src="https://unpkg.com/deck.gl@8.8.27/dist.min.js"></script>
    <!-- Google Maps API Loader -->
    <script>
      ((g) => {
        var h,
          a,
          k,
          p = "The Google Maps JavaScript API",
          c = "google",
          l = "importLibrary",
          q = "__ib__",
          m = document,
          b = window;
        b = b[c] || (b[c] = {});
        var d = b.maps || (b.maps = {}),
          r = new Set(),
          e = new URLSearchParams(),
          u = () =>
            h ||
            (h = new Promise(async (f, n) => {
              await (a = m.createElement("script"));
              e.set("libraries", [...r] + "");
              for (k in g)
                e.set(
                  k.replace(/[A-Z]/g, (t) => "_" + t[0].toLowerCase()),
                  g[k],
                );
              e.set("callback", c + ".maps." + q);
              a.src = `https://maps.${c}apis.com/maps/api/js?` + e;
              d[q] = f;
              a.onerror = () => (h = n(Error(p + " could not load.")));
              a.nonce = m.querySelector("script[nonce]")?.nonce || "";
              m.head.append(a);
            }));
        d[l]
          ? console.warn(p + " only loads once. Ignoring:", g)
          : (d[l] = (f, ...n) => r.add(f) && u().then(() => d[l](f, ...n)));
      })({ key: "AIzaSyC7y3aUhdLkZb-X11tcW0nn2nhE9VNaQmw", v: "weekly" });
    </script>
  </head>
  <body>
    <div class="container">
      <div id="map"></div>
      <form class="form" id="input-form">
        <h3>Adjust Commodity Weights</h3>
        <div class="form-description">
          Adjust the weight of each commodity based on your personal
          preferences.
        </div>
        <div class="commodity-input">
          <label for="restaurant-slider">Restaurant (0-100):</label>
          <input
            type="range"
            id="restaurant-slider"
            name="restaurant"
            min="0"
            max="100"
            value="85" />
          <span class="value-display" id="restaurant-value">85</span>
        </div>
        <div class="commodity-input">
          <label for="gas-slider">Gas (0-100):</label>
          <input
            type="range"
            id="gas-slider"
            name="gas"
            min="0"
            max="100"
            value="60" />
          <span class="value-display" id="gas-value">60</span>
        </div>
        <div class="commodity-input">
          <label for="grocery-slider">Grocery (0-100):</label>
          <input
            type="range"
            id="grocery-slider"
            name="grocery"
            max="100"
            value="40" />
          <span class="value-display" id="grocery-value">40</span>
        </div>
        <div class="commodity-input">
          <label for="pharmacy-slider">Pharmacy (0-100):</label>
          <input
            type="range"
            id="pharmacy-slider"
            name="pharmacy"
            min="0"
            max="100"
            value="70" />
          <span class="value-display" id="pharmacy-value">70</span>
        </div>

        <div class="commodity-input">
          <label for="school-slider">Schools:</label>
          <input
            type="range"
            id="school-slider"
            name="school"
            min="0"
            max="100"
            value="50" />
          <span class="value-display" id="school-value">50</span>
        </div>
        <button type="submit" class="button">Update Map</button>
        <button type="button" id="hide-form-btn" class="button hide-form-btn">
          Close
        </button>
      </form>
      <button
        id="show-form-btn"
        class="button show-form-btn"
        style="display: none">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="20"
          height="20"
          viewBox="0 0 20 20">
          <path
            d="M10,20A10,10,0,1,0,0,10,10,10,0,0,0,10,20ZM8.711,4.3l5.7,5.766L8.7,15.711,7.3,14.289l4.289-4.242L7.289,5.7Z" />
        </svg>
      </button>
      <button id="activate-geolocation" class="button geolocation">
        Go To Current Location
      </button>
      
      <!-- Debug Log Panel -->
      <div id="debug-log-panel" style="position: fixed; bottom: 0; right: 0; width: 400px; max-height: 300px; background: rgba(0,0,0,0.9); color: #0f0; font-family: monospace; font-size: 11px; overflow-y: auto; padding: 10px; z-index: 10000; display: none;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 5px; border-bottom: 1px solid #0f0; padding-bottom: 5px;">
          <strong>Debug Logs</strong>
          <button id="clear-logs-btn" style="background: transparent; border: 1px solid #0f0; color: #0f0; cursor: pointer; padding: 2px 8px;">Clear</button>
        </div>
        <div id="log-content"></div>
      </div>
      <button id="toggle-logs-btn" style="position: fixed; bottom: 10px; right: 10px; z-index: 10001; background: rgba(0,255,0,0.2); border: 2px solid #0f0; color: #0f0; padding: 8px 12px; cursor: pointer; font-family: monospace; font-weight: bold;">
        Show Logs
      </button>

      <!-- Loading Overlay -->
      <div id="loading-overlay" class="loading-overlay" style="display: none">
        <div class="loading-spinner">
          <div class="spinner"></div>
          <p class="loading-text">Updating Map...</p>
        </div>
      </div>
    </div>

    <!-- Logging utility -->
    <script>
      // Create logger that captures console.log
      (function() {
        const logPanel = document.getElementById('debug-log-panel');
        const logContent = document.getElementById('log-content');
        const toggleBtn = document.getElementById('toggle-logs-btn');
        const clearBtn = document.getElementById('clear-logs-btn');
        
        let isVisible = false;
        
        toggleBtn.addEventListener('click', () => {
          isVisible = !isVisible;
          logPanel.style.display = isVisible ? 'block' : 'none';
          toggleBtn.textContent = isVisible ? 'Hide Logs' : 'Show Logs';
        });
        
        clearBtn.addEventListener('click', () => {
          logContent.innerHTML = '';
        });
        
        // Intercept console.log
        const originalLog = console.log;
        console.log = function(...args) {
          originalLog.apply(console, args);
          
          const logEntry = document.createElement('div');
          logEntry.style.borderBottom = '1px solid #333';
          logEntry.style.padding = '3px 0';
          logEntry.style.wordWrap = 'break-word';
          
          const timestamp = new Date().toLocaleTimeString();
          const message = args.map(arg => {
            if (typeof arg === 'object') {
              try {
                return JSON.stringify(arg, null, 2);
              } catch(e) {
                return String(arg);
              }
            }
            return String(arg);
          }).join(' ');
          
          logEntry.innerHTML = `<span style="color: #888;">[${timestamp}]</span> ${message}`;
          logContent.appendChild(logEntry);
          logContent.scrollTop = logContent.scrollHeight;
        };
        
        // Intercept console.error
        const originalError = console.error;
        console.error = function(...args) {
          originalError.apply(console, args);
          
          const logEntry = document.createElement('div');
          logEntry.style.borderBottom = '1px solid #333';
          logEntry.style.padding = '3px 0';
          logEntry.style.color = '#f00';
          logEntry.style.wordWrap = 'break-word';
          
          const timestamp = new Date().toLocaleTimeString();
          const message = args.map(arg => String(arg)).join(' ');
          
          logEntry.innerHTML = `<span style="color: #888;">[${timestamp}]</span> ERROR: ${message}`;
          logContent.appendChild(logEntry);
          logContent.scrollTop = logContent.scrollHeight;
        };
      })();
    </script>

    <!-- Map and Cell classes -->
    <script src="./CalculateScore.js"></script>
    
    <!-- Commodity Scoring System -->
    <script src="./commodityScoring.js"></script>

    <!-- Main application -->
    <script src="./main.js"></script>
  </body>
</html>
